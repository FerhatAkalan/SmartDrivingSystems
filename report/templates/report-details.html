{% extends 'layout.html' %}
{% block content %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% load static %}

<div class="container">
    <h1 class="my-4">Report Details</h1>
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Report ID: {{ report.id }}</h5>
            <p class="card-text">Report Text: {{ report.report_text }}</p>
            <p class="card-text">Created At: {{ report.created_at }}</p>
            <hr>
            <h5 class="card-title">Driver Information</h5>
            <p class="card-text">Driver: {{ report.driver.driver_name }} {{ report.driver.driver_surname }}</p>
            <p class="card-text">Driver Licence: {{ report.driver.driver_licence }}</p>
            <hr>
            <h5 class="card-title">Trip Information</h5>
            <p class="card-text">Trip Start Time: {{ report.trip.start_time }}</p>
            <p class="card-text">Trip End Time: {{ report.trip.end_time }}</p>
            <hr>
            <p class="card-text">Video Path: {{ report.report_path }}</p>
            {% if report_details %}
            <p class="card-text">Safe Driving Score: {{ report_details.confidence }}</p>
            <div class="card-body">
                {% if report.report_path|slice:'-4:' == '.jpg' %}
                    <img src="{% static report.report_path %}" alt="Detected Image" class="img-fluid">
                {% elif report.report_path|slice:'-4:' == '.mp4' %}
                    <video width="100%" height="auto" controls>
                        <source src="{% static report.report_path %}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% endif %}
            </div>
            {% endif %}
            <!-- Diğer rapor detayları buraya eklenebilir -->
            <hr>
            <h5 class="card-title">Report Details </h5>
                    <div class="card-body" id="result-details">
                        {% for item in report_details %}
                            {% if item.label != "Unknown" %}
                                <div class="card-body" style="display: none;">
                                    <ul class="list-group">
                                        <li class="list-group-item">
                                            {% comment %} <strong>Detected Boxes:  {{ item.frame_info  }}</strong><br> {% endcomment %}
                                            Class: {{ item.label }}<br>
                                            Confidence: {{ item.confidence }}<br>
                                            Sol Üst Köşe (x_min, y_min): ({{ item.top_left_x }}, {{ item.top_left_y }})<br>
                                            Sağ Alt Köşe (x_max, y_max): ({{ item.bottom_right_x }}, {{ item.bottom_right_y }})<br>
                                            Merkez Koordinatlar (x_center, y_center): ({{ item.center_x }}, {{ item.center_y }})<br>
                                            Genişlik: {{ item.width }}<br>
                                            Yükseklik: {{ item.height }}<br>
                                            Masks: {{ item.masks }}<br>
                                            Keypoints: {{ item.keypoints }}<br>
                                            Probabilities: {{ item.probabilities }}<br>
                                            {% comment %} <li class="list-group-item">
                                                <strong>Frame Info:</strong><br>
                                                {{ item.frame_info  }}
                                            </li> {% endcomment %}
                                        </li>
                                    </ul>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="btn-group" role="group" aria-label="Page Navigation">
                                <button id="prev-page" class="btn btn-primary">Previous</button>
                                <button id="next-page" class="btn btn-primary">Next</button>
                                <p id="page-info" class="mb-0 mx-3"></p>
                            </div>
                        </div>
                    </div>
                    <h1>Rapor Detayları</h1>
                    <p>Rapor Numarası: {{ report.id }}</p>
                    <p>Tespit Edilen Tehlikeli Davranışlar:</p>
                    <ul>
                        {% for label_count in label_counts %}
                        <li>{{ label_count.label }}: {{ label_count.count }}</li>
                        {% endfor %}
                   </ul>
                   <h1>Rapor Detayları</h1>
                    <p>Rapor Numarası: {{ report.id }}</p>
                    <p>Tespit Edilen Tehlikeli Davranışlar:</p>
                    <canvas id="labelChart" width="20" height="20"></canvas>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <h1>Rapor Detayları</h1>
<p>Rapor Numarası: {{ report.id }}</p>
<p>Tespit Edilen Tehlikeli Davranışlar:</p>
<canvas id="labelChart" width="400" height="400"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('labelChart').getContext('2d');
    var labels = [
        {% for label_count in label_counts %}
            "{{ label_count.label }}",
        {% endfor %}
    ];
    var counts = [
        {% for label_count in label_counts %}
            {{ label_count.count }},
        {% endfor %}
    ];

    // Toplam çerçeve sayısını al
    var totalFrames = {{ report.total_frames }};

    // Geri kalan kısmı hesapla ve 'safe driving' olarak işaretle
    var safeDrivingCount = totalFrames;
    for (var i = 0; i < counts.length; i++) {
        safeDrivingCount -= counts[i];
    }

    // Hesaplanan değerleri listeye ekle
    labels.push("Safe Driving");
    counts.push(safeDrivingCount);

    var labelChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tespit Edilen Tehlikeli Davranışlar',
                data: counts,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(255, 159, 64, 0.5)',
                    'rgba(0, 128, 0, 0.5)'  // Safe Driving için yeşil renk
                ],
            }]
        },
        
    });
</script>
            <script>
                // Sayfalama işlemi için gerekli değişkenler
                var currentPage = 1;
                var itemsPerPage = 1; // Sayfa başına gösterilecek öğe sayısı
                // Sayfa yüklendiğinde ilk sayfayı göster
                showPage(currentPage);
                // Sayfalama işlemini gerçekleştiren fonksiyon
                function showPage(page) {
                    var elements = document.querySelectorAll('#result-details .card-body'); // Sonuçları içeren kartların listesi
                    // Tüm kartları gizle
                    elements.forEach(function(element) {
                        element.style.display = 'none';
                    });
                    // Belirtilen aralıktaki kartları göster
                    elements[page - 1].style.display = 'block';
                    // Sayfa bilgisini güncelle
                    var totalItems = elements.length;
                    var totalPages = Math.ceil(totalItems / itemsPerPage);
                    document.getElementById('page-info').textContent = 'Page ' + page + '/' + totalPages;
                }
                // Sayfa değiştirme düğmelerine tıklama olayını dinle
                document.getElementById('prev-page').addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage--;
                        showPage(currentPage);
                    }
                });
                document.getElementById('next-page').addEventListener('click', function() {
                    var totalItems = document.querySelectorAll('#result-details .card-body').length;
                    var totalPages = Math.ceil(totalItems / itemsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        showPage(currentPage);
                    }
                });
            </script>

            <div><a href="{% url 'driver_reports' %}" class="btn btn-primary">Back to Reports</a></div>

        </div>
    </div>
</div>
{% endblock %}

