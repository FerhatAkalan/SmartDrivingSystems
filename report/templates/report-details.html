{% extends 'layout.html' %}
{% load static %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'report/css/report-details.css' %}">
<div class="container">
    <h2 class="animated-title text-center mb-4 mt-3" style="font-family: fasterOne, sans-serif;">Report {{report.id}}</h2>
    <div class="row animated-title">
        <div class="col-md-4">
<style>
    @keyframes fadeInLeft {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    .animated-title {
        animation: fadeInLeft 0.5s ease both;
    }
    .card{
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s ease;
        overflow: hidden;
        margin-bottom: 2rem;
      }
      .card-title {
        font-weight: bold; 
      }
      .card {
        transition: transform 0.3s;
      }
      .card:hover {
        transform: translateY(-5px);
      }
</style>
<div class="container">
    <h2 class="animated-title text-center mb-4 mt-3" style="font-family: fasterOne, sans-serif;">Report {{report.id}}</h2>

    <!--Informations-->
    <div class="row">
        <div class="col-md-4">
            <div class="card border-0 shadow">
                <div class="card-body" style="background-color:#FFC93C; color: white;">
                    <h4 class="card-title">Report Information</h4>
                    <p class="card-text ">{{ report.report_text }}</p>
                    <p class="card-text ">This report created at {{ report.created_at }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow">
                <div class="card-body" style="background-color:#FF9A3C; color: white;">
                    <h4 class="card-title ">Driver Information</h4>
                    <p class="card-text ">Driver: {{ report.driver.driver_name }} {{ report.driver.driver_surname }}</p>
                    <p class="card-text ">Driver Licence: {{ report.driver.driver_licence }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow">
                <div class="card-body " style="background-color:#FF6F3C; color: white;">
                    <h4 class="card-title ">Trip Information</h4>
                    <p class="card-text ">Trip Start Time: {{ report.trip.start_time }}</p>
                    <p class="card-text ">Trip End Time: {{ report.trip.end_time }}</p>
                </div>
            </div>
        </div>
    </div>

    <!--Videos-->
    <div class="row">
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-header text-center" style="background-color:#1D267D; color: white;">in-vehicle video</div>
                    <div class="card-body">
                        {% if report.car_inside_report_path|slice:'-4:' == '.jpg' %}
                            <img src="{% static report.car_inside_report_path %}" alt="Detected Image" class="img-fluid">
                        {% elif report.car_inside_report_path|slice:'-4:' == '.mp4' %}
                            <video width="100%" height="auto" controls>
                                <source src="{% static report.car_inside_report_path %}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        {% endif %}
                    </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow"> 
                <div class="card-header text-center" style="background-color:#1D267D; color: white;"> off-vehicle video </div>
                    <div class="card-body">
                        {% if report.car_outside_report_path|slice:'-4:' == '.jpg' %}
                            <img src="{% static report.car_outside_report_path %}" alt="Detected Image" class="img-fluid">
                        {% elif report.car_outside_report_path|slice:'-4:' == '.mp4' %}
                            <video width="100%" height="auto" controls>
                                <source src="{% static report.car_outside_report_path %}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        {% endif %}
                    </div>
            </div>
        </div>
    </div>

    <!--Result Detais-->
    <div class="row">
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow">
                <div class="card-header" style="background-color:#EEEEEE; color: black;">Result Details Detected Inside the Vehicle</div>
                <div class="card-body" id="result-details-inside">
                    {% for item in report_details_interior %}
                        {% if item.label != "Unknown" %}
                        <!--Table1-->
                        <div class="card-body" style="display: none;">
                            <!--Table1-->
                            <table class="table table-bordered table-hover">
                                    <tr><th scope="row">Detected Boxes</th><td>{{ item.frame_info }}</td></tr>
                                    <tr><th scope="row">Class</th><td>{{ item.label }}</td></tr>
                                    <tr><th scope="row">Confidence</th><td>{{ item.confidence }}</td></tr>
                                    <tr><th scope="row">Sol Üst Köşe</th><td>({{ item.top_left_x }}, {{ item.top_left_y }})</td></tr>
                                    <tr><th scope="row">Sağ Alt Köşe</th><td>({{ item.bottom_right_x }}, {{ item.bottom_right_x }})</td></tr>
                                    <tr><th scope="row">Merkez Koordinatlar</th><td>({{ item.center_x }}, {{ item.center_y }})</td></tr>
                                    <tr><th scope="row">Genişlik</th><td>{{ item.width }}</td></tr>
                                    <tr><th scope="row">Yükseklik</th><td>{{ item.height }}</td></tr>
                                    <tr><th scope="row">Frame Info</th><td>{{ item.frame_info }}</td></tr>
                            </table>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">  
                        <div>
                            <button id="prev-page-inside" class="btn btn-danger">Previous</button>
                            <button id="next-page-inside" class="btn btn-danger">Next</button>
                            <p id="page-info-inside" class="mb-0 mx-3"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow">
                <div class="card-header" style="background-color:#EEEEEE; color:black;">Result Details Detected Outside the Vehicle</div>
                <div class="card-body " id="result-details-outside">
                    {% for item in report_details_exterior %}
                        {% if item.label != "Unknown" %}
                        <!--Table1-->
                            <div class="card-body" style="display: none;">
                                <table class="table table-bordered table-hover">
                                    <tr><th scope="row">Detected Boxes</th><td>{{ item.frame_info }}</td></tr>
                                    <tr><th scope="row">Class</th><td>{{ item.label }}</td></tr>
                                    <tr><th scope="row">Confidence</th><td>{{ item.confidence }}</td></tr>
                                    <tr><th scope="row">Sol Üst Köşe</th><td>({{ item.top_left_x }}, {{ item.top_left_y }})</td></tr>
                                    <tr><th scope="row">Sağ Alt Köşe</th><td>({{ item.bottom_right_x }}, {{ item.bottom_right_y }})</td></tr>
                                    <tr><th scope="row">Merkez Koordinatlar</th><td>({{ item.center_x }}, {{ item.center_y }})</td></tr>
                                    <tr><th scope="row">Genişlik</th><td>{{ item.width }}</td></tr>
                                    <tr><th scope="row">Yükseklik</th><td>{{ item.height }}</td></tr>
                                    <tr><th scope="row">Frame Info</th><td>{{ item.frame_info }}</td></tr>
                                </table>
                            </div>    
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div>
                            <button id="prev-page-outside" class="btn btn-danger">Previous</button>
                            <button id="next-page-outside" class="btn btn-danger">Next</button>
                            </div><p id="page-info-outside" class="mb-0 mx-3"></p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Labels-->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-header text-center" style="background-color:#00ADB5; color: white;"> in-vehicle labels </div>
                <div class="card-body " >
                    <table class="table" >
                        <thead>
                            <tr>
                                <th>Label</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for label_count in label_counts_interior %}
                            <tr>
                                <td>{{ label_count.label }}</td>
                                <td>{{ label_count.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-header text-center" style="background-color:#00ADB5; color: white;"> off-vehicle labels </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Label</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for label_count in label_counts_exterior %}
                            <tr>
                                <td>{{ label_count.label }}</td>
                                <td>{{ label_count.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <style>
        #labelChart, #labelChart2 {
            max-width: 60%; /* veya istediğiniz bir değer */
            max-height: auto;
        }
    </style>
    <div class="row animated-title">
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-body">
                    <canvas class="justify-content-center" id="labelChart" width="100" height="100"></canvas>
                </div>
            </div>
        </div>  
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-body">
                    <canvas id="labelChart2" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card border-0 shadow mt-4">
                <div class="card-body">
                    <canvas id="barChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow mt-4">
                <div class="card-body">
                    <canvas id="barChart2" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-body">
                    <h4>Araç İçi Davranışlar İçin Normal Dağılım Analizi</h4>
                    <img src="{{ normal_dist_plot_interior_url }}" alt="İç Davranışlar İçin Normal Dağılım Grafiği">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-body">
                    <h4>Araç Dışı Davranışlar İçin Normal Dağılım Analizi</h4>
                    <img src="{{ normal_dist_plot_exterior_url }}" alt="Dış Davranışlar İçin Normal Dağılım Grafiği">
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-body">
                    <h4>Araç İçi Davranışlar İçin Üstel Dağılım Analizi</h4>
                    <img src="{{ exponential_dist_plot_interior_url }}" alt="İç Davranışlar İçin Üstel Dağılım Grafiği">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-body">
                    <h4>Araç Dışı Davranışlar için Üstel Dağılım Analizi</h4>
                    <img src="{{ exponential_dist_plot_exterior_url }}" alt="Dış Davranışlar İçin Üstel Dağılım Grafiği">
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="card h-100 border-0 shadow">
                <div class="card-header" style="background-color:#EEEEEE; color: black;">Speed vs Time Graph</div>
                <div class="card-body">
                    <div id="graph"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="d-flex justify-content-center"><a href="{% url 'driver_reports' %}" class="btn btn-danger mt-3 mb-3 md-3">Back to Reports</a></div></div>
    </div>
</div>   
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'report/js/report_details_pagination.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var times = {{ times|safe }};
        var speeds = {{ speeds|safe }};
        var speedLimits = {{ speed_limits|safe }};

        var speedTrace = {
            x: times,
            y: speeds,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Detected Speed',
            marker: { color: 'red' }
        };

        var limitTrace = {
            x: times,
            y: speedLimits,
            type: 'scatter',
            mode: 'lines',
            name: 'Speed Limit',
            line: { dash: 'dash', color: 'blue' }
        };

        var layout = {
            title: 'Speed vs Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Speed' }
        };

        Plotly.newPlot('graph', [speedTrace, limitTrace], layout);
    });
    //Label Chart
    var ctx = document.getElementById('labelChart').getContext('2d');
    var labels = [
        {% for label_count in label_counts_interior %}
        "{{ label_count.label }}",
        {% endfor %}
    ];
    var counts = [
        {% for label_count in label_counts_interior %}
        {{ label_count.count }},
        {% endfor %}
    ];

    // Toplam çerçeve sayısını al
    var total_frames_inside = {{ report.total_frames_inside }};
    var total_frames_outside = {{ report.total_frames_outside }};

    // Geri kalan kısmı hesapla ve 'safe driving' olarak işaretle
    var safeDrivingCount = total_frames_inside;
    for (var i = 0; i < counts.length; i++) {
        safeDrivingCount -= counts[i];
    }

    // Hesaplanan değerleri listeye ekle
    labels.push("safe driving");
    counts.push(safeDrivingCount);

    var labelChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tespit Edilen Davranışlar',
                data: counts,
                backgroundColor: [
                    "#f15a5a", "#b47cc7", "#6d6e71", "#ffd700","#86c5da", "#f39237", "#7ac943"
                ],
            }]
        },
        options: {
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            var sum = counts.reduce(function(a, b) { return a + b; }, 0);
                            var value = counts[tooltipItem.dataIndex];
                            var percentage = (value / sum * 100).toFixed(2);
                            return tooltipItem.label + ': ' + percentage + '%';
                        }
                    }
                }
            }
        }
    });

    var ctx2 = document.getElementById('labelChart2').getContext('2d');
    var labels2 = [
        {% for label_count in label_counts_exterior %}
        "{{ label_count.label }}",
        {% endfor %}
    ];
    var counts2 = [
        {% for label_count in label_counts_exterior %}
        {{ label_count.count }},
        {% endfor %}
    ];

    var safeDrivingCount2 = total_frames_outside;
    for (var i = 0; i < counts2.length; i++) {
        safeDrivingCount2 -= counts2[i];
    }

    labels2.push("safe driving");
    counts2.push(safeDrivingCount2);

    var labelChart2 = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: labels2,
            datasets: [{
                label: 'Tespit Edilen Davranışlar',
                data: counts2,
                backgroundColor: [
                    "#f15a5a", "#b47cc7", "#6d6e71", "#ffd700","#86c5da", "#f39237", "#7ac943"
                ],
            }]
        },
        options: {plugins: {tooltip: {callbacks: {label: function(tooltipItem) {
                            var sum = counts2.reduce(function(a, b) { return a + b; }, 0);
                            var value = counts2[tooltipItem.dataIndex];
                            var percentage = (value / sum * 100).toFixed(2);
                            return tooltipItem.label + ': ' + percentage + '%';
                        }
                    }
                }
            }
        }
    });

    var barCtx = document.getElementById('barChart').getContext('2d');
    var barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Frequency of Driving Behaviors',
                data: counts,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]},
        options: {scales: {y: {beginAtZero: true}}}
    });

    var barCtx2 = document.getElementById('barChart2').getContext('2d');
    var barChart2 = new Chart(barCtx2, {
        type: 'bar',
        data: {
            labels: labels2,
            datasets: [{
                label: 'Frequency of Driving Behaviors',
                data: counts,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {scales: {y: {beginAtZero: true}}}
    });
</script>

{% endblock %}